<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeper Monitoring â€“ 100% Offline & Anonym</title>
    <meta name="description" content="KI fÃ¼r Imker â€“ komplett offline, anonym, kostenlos">
    <link rel="manifest" href="data:application/manifest+json,{
      \"name\": \"Beekeeper Monitoring\",
      \"short_name\": \"BeeAlarm\",
      \"start_url\": \".\",
      \"display\": \"standalone\",
      \"background_color\": \"#1a5f1a\",
      \"theme_color\": \"#1a5f1a\",
      \"icons\": [{
        \"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2002000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ%3C/text%3E%3C/svg%3E\",
        \"sizes\": \"192x192\",
        \"type\": \"image/svg+xml\"
      }]
    }">

    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f0f8ff; text-align:center; }
        body.dark { background:#111; color:#fff; }
        header { background:#1a5f1a; color:white; padding:30px; border-radius:0 0 20px 20px; }
        body.dark header { background:#8B0000; }
        .card { background:white; border-radius:16px; padding:25px; margin:20px auto; max-width:560px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        body.dark .card { background:#1f1f1f; }
        button { background:#27ae60; color:white; padding:16px 32px; border:none; border-radius:16px; font-size:18px; margin:15px; cursor:pointer; }
        button:hover { background:#1e8449; }
        input { width:90%; padding:16px; border:2px solid #ddd; border-radius:16px; font-size:18px; margin:15px; }
        #video { width:100%; max-width:640px; border:4px solid #4CAF50; border-radius:20px; }
        #canvas { position:absolute; top:0; left:0; pointer-events:none; border-radius:20px; }
        .alert { background:#ffebee; color:#c62828; padding:20px; border-radius:16px; margin:20px; font-weight:bold; font-size:20px; }
        body.dark .alert { background:#440000; color:#ff6666; }
    </style>
</head>
<body>
    <header>
        <h1>Beekeeper Monitoring</h1>
        <p>100 % offline Â· 100 % anonym Â· 100 % kostenlos</p>
    </header>

    <div class="card">
        <h2>Deine private Alarm-Nummer</h2>
        <p>(wird nur auf deinem GerÃ¤t gespeichert â€“ niemand sieht sie!)</p>
        <input type="tel" id="phone" placeholder="+4915112345678" />
        <button onclick="save()">Speichern</button>
        <p id="status" style="color:green; font-weight:bold; font-size:18px;"></p>
    </div>

    <div class="card">
        <button onclick="start()">Kamera starten</button>
        <button onclick="stop()" id="stopBtn" style="display:none;">Stop</button>
        <button onclick="toggleDark()">Dark Mode</button>
    </div>

    <div style="position:relative; margin:30px 0;">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="alarm" class="alert" style="display:none;">
        HORNISSEN-ALARM! SMS an deine Nummer gesendet!
    </div>

    <script>
        let stream, video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let running = false;

        function save() {
            const num = document.getElementById('phone').value.trim();
            if (num && num.match(/^\+49[1-9][0-9]{8,11}$/)) {
                localStorage.setItem('beekeeper_phone', num);
                document.getElementById('status').textContent = 'Gespeichert: ' + num;
            } else alert('Bitte gÃ¼ltige deutsche Nummer (+49...) eingeben');
        }
        if (localStorage.getItem('beekeeper_phone')) {
            document.getElementById('status').textContent = 'Deine Nummer: ' + localStorage.getItem('beekeeper_phone');
        }

        async function start() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('stopBtn').style.display = 'inline';
                    running = true;
                    loop();
                };
            } catch(e) { alert('Kamera-Zugriff verweigert â€“ bitte erlauben!'); }
        }

        function stop() {
            if (stream) stream.getTracks().forEach(t=>t.stop());
            document.getElementById('stopBtn').style.display = 'none';
            running = false;
        }

        function toggleDark() { document.body.classList.toggle('dark'); }

        function loop() {
            if (!running) return;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            // Einfache Bewegung + Farberkennung (gelb/schwarz = Hornisse)
            const imgData = ctx.getImageData(0,0,canvas.width,canvas.height).data;
            let yellow = 0, black = 0;
            for (let i = 0; i < imgData.length; i += 12) {
                const r = imgData[i], g = imgData[i+1], b = imgData[i+2];
                if (r > 180 && g > 150 && b < 100) yellow++;
                if (r < 80 && g < 80 && b < 80) black++;
            }
            if (yellow > 3000 && black > 3000) {
                ctx.strokeStyle = 'red'; ctx.lineWidth = 12;
                ctx.strokeRect(30,30,canvas.width-60,canvas.height-60);
                ctx.fillStyle = 'red'; ctx.font = '60px Arial';
                ctx.fillText('HORNISSE!', 100, 120);
                document.getElementById('alarm').style.display = 'block';
                sendOfflineSMS();
            }
            requestAnimationFrame(loop);
        }

        function sendOfflineSMS() {
            const phone = localStorage.getItem('beekeeper_phone');
            if (!phone) return;
            // 100% lokal: Ã¶ffnet Mail-Client mit SMS-Gateway
            const carrier = phone.startsWith('+49170') || phone.startsWith('+49171') || phone.startsWith('+49175') ? 'sms.telekom.de' :
                           phone.startsWith('+49172') || phone.startsWith('+49178') ? 'sms.vodafone.de' :
                           phone.startsWith('+49176') ? 'o2online.de' : 'sms.telekom.de';
            const smsTo = phone.replace('+49','').replace(/[^0-9]/g,'') + '@' + carrier;
            const subject = "Beekeeper-Alarm!";
            const body = "HORNISSE erkannt! Sofort prÃ¼fen!";
            location.href = `mailto:${smsTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }
    </script>
</body>
</html>
