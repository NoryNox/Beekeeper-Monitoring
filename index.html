<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeper Monitoring: Deine Bienen-App</title>
    <meta name="description" content="Echtzeit-Ãœberwachung fÃ¼r Imker: Hornissen, Varroa & mehr. Mit SMS-Alarm!">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f8ff; text-align: center; }
        body.dark { background: #1a1a1a; color: #fff; }
        header { background: #4CAF50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; max-width: 800px; margin: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        body.dark section { background: #333; }
        #video { width: 100%; max-width: 640px; border: 2px solid #4CAF50; border-radius: 8px; }
        #canvas { position: absolute; top: 0; left: 0; pointer-events: none; }
        button { padding: 12px 20px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button:hover { background: #45a049; }
        .sms-btn { background: #FF5722 !important; }
        .alert { color: red; font-weight: bold; padding: 10px; background: #ffebee; border-radius: 5px; margin: 10px 0; }
        .dashboard { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px auto; max-width: 640px; }
        body.dark .dashboard { background: #444; }
        #loading { color: #4CAF50; font-size: 18px; }
        #history { max-height: 150px; overflow-y: auto; text-align: left; background: white; padding: 10px; border-radius: 5px; margin-top: 10px; }
        body.dark #history { background: #555; }
        .info-box { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@latest"></script>
</head>
<body>
    <header>
        <h1>ğŸ Beekeeper Monitoring</h1>
        <p>Deine KI-App fÃ¼r BienenstÃ¶cke: Erkennt Bedrohungen in Echtzeit. Mit SMS-Alarm!</p>
    </header>

    <section id="info">
        <h2>Was die App kann</h2>
        <div class="info-box">
            <p>Ãœberwache Hornissen, Varroa-Milben & SchwÃ¤rme per Kamera + Mikrofon. Alarme & Logs â€“ alles lokal auf deinem GerÃ¤t.</p>
            <ul style="text-align: left;">
                <li>ğŸ” Echtzeit-Detektion (Bild + Sound).</li>
                <li>ğŸ”” Push-Alarme bei Gefahr.</li>
                <li>ğŸ“± Offline-PWA (installierbar).</li>
                <li>ğŸ’¾ Logs exportieren fÃ¼r Reports.</li>
                <li>ğŸ“± <strong>Neu: SMS-Alarm</strong> (gratis via Fast2SMS).</li>
            </ul>
            <p><strong>Tipp:</strong> Starte mit Kamera â€“ die App lernt von dir!</p>
        </div>
    </section>

    <div id="loading">App lÃ¤dt... (YOLOv10n initialisiert.)</div>
    <div id="controls">
        <button id="startBtn">ğŸš€ Kamera & Mikrofon starten</button>
        <button id="stopBtn" style="display:none;">â¹ Stop</button>
        <button id="smsTestBtn" class="sms-btn">ğŸ“± SMS-Alarm testen</button>
        <button id="exportLogs" style="background: #2196F3;">ğŸ“¤ Logs exportieren</button>
        <button id="darkToggle" style="background: #9E9E9E;">ğŸŒ™ Dark Mode</button>
        <div id="weather" style="margin: 10px; font-size: 14px;">Wetter-Simulation: 18Â°C â€“ Hohe AktivitÃ¤t! âš ï¸</div>
    </div>
    <div style="position: relative; display: inline-block; margin: 20px 0;">
        <video id="video" autoplay playsinline muted style="border-radius: 8px;"></video>
        <canvas id="canvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
    </div>
    <div id="result" class="alert" style="display: none;">Alarm: Bedrohung erkannt!</div>
    
    <div class="dashboard">
        <h3>Dashboard</h3>
        <p>Status: <span id="status">Bereit</span> | Detektionen: <span id="detections">0</span> | Alarme: <span id="alarms">0</span></p>
        <h4>Letzte Events</h4>
        <div id="history">Keine Logs â€“ starte die App!</div>
    </div>

    <script>
        const API_ENDPOINT = 'http://localhost:5000/api/alarm';  // Backend
        const MODEL_URL = 'models/yolov10n_tfjs/model.json';  // Dein Modell

        let model, video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let stream, animationId, isRunning = false, logs = JSON.parse(localStorage.getItem('beekeeperLogs') || '[]'), alarmCounter = 0;
        let detectionsList = document.getElementById('detections'), alarmsCount = document.getElementById('alarms'), statusEl = document.getElementById('status');

        // UI-Funktionen
        function updateHistory() {
            document.getElementById('history').innerHTML = logs.length > 0 ? logs.slice(0, 5).map(log => `<div>${log.timestamp}: ${log.event}</div>`).join('') : 'Keine Logs â€“ starte!';
        }
        function addLog(event) {
            logs.unshift({ timestamp: new Date().toLocaleString(), event });
            if (logs.length > 50) logs = logs.slice(0, 50);
            localStorage.setItem('beekeeperLogs', JSON.stringify(logs));
            updateHistory();
        }
        updateHistory();

        document.getElementById('exportLogs').onclick = () => {
            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'beekeeper-logs.json'; a.click();
            addLog('Logs exportiert');
        };

        document.getElementById('darkToggle').onclick = () => {
            document.body.classList.toggle('dark');
            addLog('Dark Mode gewechselt');
        };

        // SMS-Test
        document.getElementById('smsTestBtn').onclick = async () => {
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score: 0.85, message: 'Test-Alarm' })
                });
                const data = await response.json();
                document.getElementById('result').innerHTML = `SMS gesendet! ${data.message}`;
                addLog('SMS getestet');
            } catch (err) {
                alert('Backend nicht gestartet â€“ run python src/app.py');
            }
        };

        // Modell laden
        async function loadModel() {
            try {
                tf.setBackend('webgl'); await tf.ready();
                model = await tf.loadGraphModel(MODEL_URL);
                statusEl.innerText = 'YOLOv10n geladen!';
            } catch (error) {
                console.warn('Custom-Modell fehlt â€“ Fallback zu YOLOv8n');
                model = await tf.loadGraphModel('https://tfhub.dev/google/tfjs-model/yolov8n-detection/1/default/1', { fromTFHub: true });
                statusEl.innerText = 'Fallback-Modell geladen';
            }
            document.getElementById('loading').innerHTML = 'Bereit â€“ starte Kamera!';
            addLog('Modell geladen');
        }

        // Start Kamera
        document.getElementById('startBtn').onclick = async () => {
            if (!model) await loadModel();
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 }, audio: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    detectLoop();
                };
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline';
                isRunning = true; statusEl.innerText = 'LÃ¤uft!';
                addLog('Kamera gestartet');
            } catch (err) {
                alert('Zugriff fehlgeschlagen: ' + err.message + '. Erlaube in Browser.');
            }
        };

        document.getElementById('stopBtn').onclick = () => {
            if (stream) stream.getTracks().forEach(track => track.stop());
            document.getElementById('startBtn').style.display = 'inline';
            document.getElementById('stopBtn').style.display = 'none';
            isRunning = false; statusEl.innerText = 'Gestoppt';
            addLog('Kamera gestoppt');
        };

        // Echtzeit-Detektion
        async function detectLoop() {
            if (isRunning && video.readyState === 4) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                const tensor = tf.browser.fromPixels(video).resizeNearestNeighbor([640, 640]).toFloat().div(255.0).expandDims(0);
                const predictions = await model.executeAsync(tensor);
                const scoresData = predictions[1].dataSync();
                const maxScore = Math.max(...scoresData);
                if (maxScore > 0.5) {
                    detectionsList.innerText = maxScore.toFixed(2);
                    ctx.strokeStyle = 'red'; ctx.lineWidth = 3;
                    ctx.strokeRect(100, 100, 200, 150);  // Beispiel-Box (fine-tune fÃ¼r Position)
                    ctx.fillStyle = 'red'; ctx.font = '20px Arial';
                    ctx.fillText(`Detektiert: ${(maxScore * 100).toFixed(0)}%`, 110, 95);
                    if (maxScore > 0.7) {
                        await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ score: maxScore, message: 'Echte Bedrohung!' })
                        });
                        triggerAlarm('Bedrohung', maxScore);
                    }
                }
                tensor.dispose(); predictions.forEach(p => p.dispose());
            }
            animationId = requestAnimationFrame(detectLoop);
        }

        function triggerAlarm(className, score) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = `ALARM: ${className} (${(score * 100).toFixed(1)}%)! SMS gesendet.`;
            alarmCounter++; alarmsCount.innerText = alarmCounter;
            if (Notification.permission === 'granted') new Notification('Beekeeper Alarm!', { body: `${className} erkannt! SMS unterwegs.` });
            addLog(`Alarm: ${className} + SMS`);
        }

        if (Notification.permission === 'default') Notification.requestPermission();
        window.onbeforeunload = () => { if (stream) stream.getTracks().forEach(track => track.stop()); if (animationId) cancelAnimationFrame(animationId); };
        loadModel();
        addLog('App geladen');
        document.getElementById('loading').style.display = 'none';
    </script>
</body>
</html>
