<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeper Monitoring ‚Äì Hornissen & Varroa Live-√úberwachung</title>
    <meta name="description" content="KI-App f√ºr Imker: Echtzeit-Erkennung von Hornissen, Varroa & mehr ‚Äì mit SMS-Alarm">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap');
        body { font-family: 'Roboto', sans-serif; margin:0; padding:20px; background:#f0f8ff; color:#2d3436; text-align:center; transition:all 0.3s; }
        body.dark { background:#111111; color:#e0e0e0; }
        header { background:#1a5f1a; color:white; padding:25px; border-radius:0 0 20px 20px; box-shadow:0 8px 25px rgba(0,0,0,0.2); }
        body.dark header { background:#8B0000 !important; color:#ffffff !important; border-bottom:4px solid #ff3333; }
        body.dark header h1, body.dark header p { color:#ffffff !important; }
        .card { background:white; border-radius:16px; padding:20px; margin:20px auto; max-width:560px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        body.dark .card { background:#1f1f1f; border:1px solid #444; }
        button { background:#27ae60; color:white; border:none; padding:14px 28px; border-radius:12px; font-size:16px; cursor:pointer; margin:10px; transition:all 0.3s; }
        button:hover { background:#1e8449; transform:translateY(-2px); }
        .sms-btn { background:#e74c3c !important; }
        input { width:100%; padding:14px; border:2px solid #ddd; border-radius:12px; font-size:16px; margin:10px 0; }
        #video { width:100%; max-width:640px; border:3px solid #4CAF50; border-radius:16px; background:#000; }
        #canvas { position:absolute; top:0; left:0; pointer-events:none; border-radius:16px; }
        .alert { background:#ffebee; color:#c62828; padding:15px; border-radius:12px; margin:15px 0; font-weight:bold; border:2px solid #ef9a9a; }
        body.dark .alert { background:#440000; color:#ff4444; border-color:#ff6666; }
        .dashboard { background:#e8f5e8; border-radius:16px; padding:20px; margin:20px auto; max-width:560px; }
        body.dark .dashboard { background:#1a1a1a; }
        #loading { font-size:20px; color:#27ae60; margin:30px; }
        #history { background:white; padding:12px; border-radius:12px; max-height:180px; overflow-y:auto; text-align:left; margin-top:10px; }
        body.dark #history { background:#1e1e1e; color:#ddd; }
        .info-box { background:#fff3cd; border:1px solid #ffeaa7; padding:15px; border-radius:12px; margin:10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@latest"></script>
</head>
<body>
    <header>
        <h1>üêù Beekeeper Monitoring</h1>
        <p>Deine KI-App f√ºr Bienenst√∂cke: Erkennt Bedrohungen in Echtzeit. Einfach, offline, hilfreich.</p>
    </header>

    <section id="info">
        <h2>Was die App kann</h2>
        <div class="info-box">
            <p>√úberwache Hornissen, Varroa-Milben & Schw√§rme per Kamera + Mikrofon. Alarme & Logs ‚Äì alles lokal auf deinem Ger√§t.</p>
            <ul style="text-align: left;">
                <li>üîç Echtzeit-Detektion (Bild + Sound).</li>
                <li>üîî Push-Alarme bei Gefahr.</li>
                <li>üì± Offline-PWA (installierbar).</li>
                <li>üíæ Logs exportieren f√ºr Reports.</li>
            </ul>
            <p><strong>Tipp:</strong> Starte mit Kamera ‚Äì die App lernt von dir!</p>
        </div>
    </section>

    <div id="loading">App l√§dt... (Falls Modell fehlt, nutzt Fallback.)</div>
    <div id="controls">
        <button id="startBtn">üöÄ Kamera & Mikrofon starten</button>
        <button id="stopBtn" style="display:none;">‚èπ Stop</button>
        <button id="exportLogs" style="background: #2196F3;">üì§ Logs exportieren</button>
        <button id="darkToggle" style="background: #9E9E9E;">üåô Dark Mode</button>
        <div id="weather" style="margin: 10px; font-size: 14px;">Wetter-Simulation: 18¬∞C ‚Äì Hohe Aktivit√§t! ‚ö†Ô∏è</div>
    </div>
    <div style="position: relative; display: inline-block; margin: 20px 0;">
        <video id="video" autoplay playsinline muted style="border-radius: 8px;"></video>
        <canvas id="canvas" style="position: absolute; top: 0; left: 0; pointer-events: none;"></canvas>
    </div>
    <div id="result" class="alert" style="display: none;">Demo-Alarm: Hornisse erkannt! (Klick Start f√ºr Real.)</div>
    
    <div class="dashboard">
        <h3>Dashboard</h3>
        <p>Status: <span id="status">Bereit</span> | Detektionen: <span id="detections">0</span> | Alarme: <span id="alarms">0</span></p>
        <h4>Letzte Events</h4>
        <div id="history">Keine Logs ‚Äì starte die App!</div>
    </div>

    <script>
        // Konfig (keine Platzhalter ‚Äì alles lokal)
        const MODEL_URL = 'https://tfhub.dev/google/tfjs-model/yolov8n-detection/1/default/1';  // Fallback-Modell
        let model, video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let stream, animationId, isRunning = false, logs = JSON.parse(localStorage.getItem('beekeeperLogs') || '[]'), alarmCounter = 0;
        let detectionsList = document.getElementById('detections'), alarmsCount = document.getElementById('alarms'), statusEl = document.getElementById('status');

        // UI-Updates
        function updateHistory() {
            document.getElementById('history').innerHTML = logs.length > 0 ? logs.slice(0, 5).map(log => `<div>${log.timestamp}: ${log.event}</div>`).join('') : 'Keine Logs ‚Äì starte!';
        }
        function addLog(event) {
            logs.unshift({ timestamp: new Date().toLocaleString(), event });
            if (logs.length > 50) logs = logs.slice(0, 50);
            localStorage.setItem('beekeeperLogs', JSON.stringify(logs));
            updateHistory();
        }
        updateHistory();

        document.getElementById('exportLogs').onclick = () => {
            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'beekeeper-logs.json'; a.click();
            addLog('Logs exportiert');
        };

        document.getElementById('darkToggle').onclick = () => {
            document.body.classList.toggle('dark');
            addLog('Dark Mode gewechselt');
        };

        // Modell laden (Fallback integriert)
        async function loadModel() {
            try {
                tf.setBackend('webgl'); await tf.ready();
                model = await tf.loadGraphModel(MODEL_URL, { fromTFHub: true });
                statusEl.innerText = 'Modell geladen!';
                console.log('YOLOv8n ready');
            } catch (error) {
                statusEl.innerText = 'Demo-Modus (Modell-Fehler)';
                console.error('Modell-Load failed:', error);
            }
        }

        // Kamera starten (Fix: facingMode f√ºr Mobile)
        document.getElementById('startBtn').onclick = async () => {
            if (!model) await loadModel();
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }, 
                    audio: true 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline';
                    isRunning = true;
                    detectLoop();
                    addLog('Kamera gestartet');
                };
            } catch (err) {
                console.error('Kamera-Fehler:', err);
                alert('Kamera-Zugriff fehlgeschlagen: ' + err.message + '. Erlaube in Browser-Einstellungen.');
            }
        };

        document.getElementById('stopBtn').onclick = () => {
            if (stream) stream.getTracks().forEach(track => track.stop());
            document.getElementById('startBtn').style.display = 'inline';
            document.getElementById('stopBtn').style.display = 'none';
            isRunning = false;
            statusEl.innerText = 'Gestoppt';
            addLog('Kamera gestoppt');
        };

        // Echtzeit-Detektion (Fix: Error-Handling, Scores)
        async function detectLoop() {
            if (isRunning && video.readyState === 4 && model) {
                const tensor = tf.browser.fromPixels(video).resizeNearestNeighbor([640, 640]).toFloat().div(255.0).expandDims(0);
                const predictions = await model.executeAsync(tensor);
                const scoresData = predictions[1].dataSync();
                const maxScore = Math.max(...scoresData);
                if (maxScore > 0.5) {
                    detectionsList.innerText = maxScore.toFixed(2);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = 'red'; ctx.lineWidth = 3;
                    ctx.strokeRect(100, 100, 200, 150);
                    ctx.fillStyle = 'red'; ctx.font = '20px Arial';
                    ctx.fillText(`Detektiert: ${(maxScore * 100).toFixed(0)}%`, 110, 95);
                    if (maxScore > 0.7) {
                        triggerAlarm('Bedrohung', maxScore);
                    }
                }
                tensor.dispose(); predictions.forEach(p => p.dispose());
            } else if (isRunning) {
                // Demo-Fallback
                detectionsList.innerText = 'Demo-Modus';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = 'orange'; ctx.lineWidth = 2;
                ctx.strokeRect(100, 100, 200, 150);
                ctx.fillText('Demo: Insekt (65%)', 110, 95);
            }
            animationId = requestAnimationFrame(detectLoop);
        }

        function triggerAlarm(className, score) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = `ALARM: ${className} (${(score * 100).toFixed(1)}%)!`;
            alarmCounter++; alarmsCount.innerText = alarmCounter;
            if (Notification.permission === 'granted') new Notification('Beekeeper Alarm!', { body: `${className} erkannt!` });
            addLog(`Alarm: ${className}`);
        }

        if (Notification.permission === 'default') Notification.requestPermission();
        window.onbeforeunload = () => { if (stream) stream.getTracks().forEach(track => track.stop()); if (animationId) cancelAnimationFrame(animationId); };
        loadModel();
        addLog('App geladen');
        document.getElementById('loading').style.display = 'none';
    </script>
</body>
</html>
