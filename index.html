<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeper Monitoring ‚Äì Vollst√§ndige Imker-KI</title>
    <meta name="description" content="Echtzeit-Erkennung von Hornissen, Varroa & mehr ‚Äì mit Registrierung, SMS-Alarm und Anleitungen">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a5f1a">
    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f0f8ff; text-align:center; }
        body.dark { background:#111; color:#fff; }
        header { background:#1a5f1a; color:white; padding:30px; border-radius:0 0 25px 25px; }
        body.dark header { background:#8B0000; }
        .card { background:white; border-radius:16px; padding:25px; margin:20px auto; max-width:560px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        body.dark .card { background:#1f1f1f; }
        input { width:90%; padding:14px; border:2px solid #ddd; border-radius:12px; font-size:16px; margin:10px 0; }
        button { background:#27ae60; color:white; border:none; padding:14px 28px; border-radius:12px; font-size:16px; cursor:pointer; margin:10px; }
        button:hover { background:#1e8449; }
        .next-btn { background:#2196F3 !important; }
        #video { width:100%; max-width:640px; border:3px solid #4CAF50; border-radius:16px; background:#000; }
        #canvas { position:absolute; top:0; left:0; pointer-events:none; border-radius:16px; }
        .alert { background:#ffebee; color:#c62828; padding:15px; border-radius:12px; margin:15px 0; font-weight:bold; border:2px solid #ef9a9a; }
        body.dark .alert { background:#440000; color:#ff4444; border-color:#ff6666; }
        .dashboard { background:#e8f5e8; border-radius:16px; padding:20px; margin:20px auto; max-width:560px; }
        body.dark .dashboard { background:#1a1a1a; }
        #loading { font-size:20px; color:#27ae60; margin:30px; }
        #history { background:white; padding:12px; border-radius:12px; max-height:180px; overflow-y:auto; text-align:left; margin-top:10px; }
        body.dark #history { background:#1e1e1e; }
        .info-box { background:#fff3cd; border:1px solid #ffeaa7; padding:15px; border-radius:12px; margin:10px 0; }
        .guide { background:#e8f5e8; border:1px solid #c8e6c9; padding:15px; border-radius:12px; margin:10px 0; text-align:left; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@latest"></script>
</head>
<body>
    <header>
        <h1>üêù Beekeeper Monitoring</h1>
        <p>Deine KI-App f√ºr Bienenst√∂cke: Erkennt Bedrohungen in Echtzeit. Einfach, offline, hilfreich.</p>
    </header>

    <section id="info">
        <h2>Was die App kann</h2>
        <div class="info-box">
            <p>√úberwache Hornissen, Varroa-Milben & Schw√§rme per Kamera + Mikrofon. Alarme & Logs ‚Äì alles lokal auf deinem Ger√§t.</p>
            <ul style="text-align: left;">
                <li>üîç Echtzeit-Detektion (Bild + Sound).</li>
                <li>üîî Push-Alarme bei Gefahr.</li>
                <li>üì± Offline-PWA (installierbar).</li>
                <li>üíæ Logs exportieren f√ºr Reports.</li>
            </ul>
            <p><strong>Tipp:</strong> Starte mit Kamera ‚Äì die App lernt von dir!</p>
        </div>
    </section>

    <!-- Registrierung -->
    <div id="registerCard" class="card">
        <h2>Willkommen, Imker!</h2>
        <p>Deine Daten bleiben nur auf deinem Ger√§t ‚Äì 100% anonym!</p>

        <div id="step1">
            <h3>Schritt 1: Deine E-Mail (optional)</h3>
            <input type="email" id="email" placeholder="deine@email.de (optional)" />
            <button onclick="goToStep2()" class="next-btn">Weiter zur Nummer</button>
        </div>

        <div id="step2" style="display:none;">
            <h3>Schritt 2: Deine Handynummer (f√ºr SMS-Alarme)</h3>
            <input type="tel" id="phone" placeholder="+4915112345678" />
            <button onclick="completeRegistration()">Speichern & App starten</button>
        </div>

        <div id="status" style="margin-top:20px; font-weight:bold; color:green;"></div>
    </div>

    <!-- Haupt-App -->
    <div id="mainApp" style="display:none;">
        <div class="card">
            <h2>Bereit zum Starten</h2>
            <button onclick="start()">Kamera starten</button>
            <button onclick="stop()" id="stopBtn" style="display:none;">Stop</button>
            <button onclick="toggleDark()">Dark Mode</button>
            <button onclick="exportLogs()">Logs exportieren</button>
        </div>

        <div style="position:relative; margin:30px 0;">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>

        <div id="result" class="alert" style="display: none;">ALARM: Bedrohung erkannt!</div>

        <div class="dashboard">
            <h3>Dashboard</h3>
            <p>Status: <span id="status">Bereit</span> | Detektionen: <span id="detections">0</span> | Alarme: <span id="alarms">0</span></p>
            <h4>Letzte Events</h4>
            <div id="history">Keine Logs ‚Äì starte die App!</div>
        </div>
    </div>

    <!-- Anleitungen -->
    <section id="guide">
        <h2>Registrierungs-Anleitung</h2>
        <div class="guide">
            <p><strong>Schritt 1:</strong> Gib deine E-Mail ein (optional, zum Merken).</p>
            <p><strong>Schritt 2:</strong> Gib deine Handynummer ein (+49...).</p>
            <p><strong>Schritt 3:</strong> Klick "Speichern & App starten" ‚Äì fertig!</p>
            <p><strong>Hinweis:</strong> Alle Daten bleiben nur auf deinem Ger√§t. Keine √úbertragung.</p>
        </div>

        <h2>Bau-Anleitung (Raspberry Pi)</h2>
        <div class="guide">
            <p><strong>Hardware:</strong> Raspberry Pi 4 + Arducam-Kamera + 5V-Netzteil.</p>
            <p><strong>Setup:</strong> Raspbian installieren > `sudo apt update` > `pip install ultralytics opencv-python`.</p>
            <p><strong>Training:</strong> `python src/train_multimodal.py` (Dataset von Kaggle).</p>
            <p><strong>Start:</strong> `python src/app.py` ‚Äì Kamera l√§uft, Alarme per SMS.</p>
            <p><strong>Download:</strong> Dataset: Kaggle Vespa Velutina.</p>
        </div>

        <h2>Nutzungs-Anleitung</h2>
        <div class="guide">
            <p><strong>1. App √∂ffnen:</strong> Registrierung (einmalig).</p>
            <p><strong>2. Kamera starten:</strong> Erlaube Zugriff ‚Äì richte auf Stock.</p>
            <p><strong>3. Alarm:</strong> Rote Box + SMS bei Bedrohung.</p>
            <p><strong>4. Logs:</strong> "Logs exportieren" ‚Äì JSON f√ºr Reports.</p>
            <p><strong>5. Offline:</strong> Installiere als App ‚Äì l√§uft ohne Internet.</p>
        </div>
    </section>

    <script>
        const MODEL_URL = 'https://tfhub.dev/google/tfjs-model/yolov8n-detection/1/default/1';
        let model, video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let stream, animationId, isRunning = false, logs = JSON.parse(localStorage.getItem('beekeeperLogs') || '[]'), alarmCounter = 0;
        let detectionsList = document.getElementById('detections'), alarmsCount = document.getElementById('alarms'), statusEl = document.getElementById('status');

        function updateHistory() {
            document.getElementById('history').innerHTML = logs.length > 0 ? logs.slice(0, 5).map(log => `<div>${log.timestamp}: ${log.event}</div>`).join('') : 'Keine Logs ‚Äì starte die App!';
        }
        function addLog(event) {
            logs.unshift({ timestamp: new Date().toLocaleString(), event });
            if (logs.length > 50) logs = logs.slice(0, 50);
            localStorage.setItem('beekeeperLogs', JSON.stringify(logs));
            updateHistory();
        }
        updateHistory();

        document.getElementById('exportLogs').onclick = () => {
            const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'beekeeper-logs.json'; a.click();
            addLog('Logs exportiert');
        };

        document.getElementById('darkToggle').onclick = () => {
            document.body.classList.toggle('dark');
            addLog('Dark Mode gewechselt');
        };

        async function loadModel() {
            try {
                tf.setBackend('webgl'); await tf.ready();
                model = await tf.loadGraphModel(MODEL_URL, { fromTFHub: true });
                statusEl.innerText = 'Modell geladen!';
            } catch (error) {
                statusEl.innerText = 'Demo-Modus';
                console.error('Modell-Load:', error);
            }
        }

        document.getElementById('startBtn').onclick = async () => {
            if (!model) await loadModel();
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline';
                    isRunning = true;
                    detectLoop();
                    addLog('Kamera gestartet');
                };
            } catch (err) {
                alert('Kamera-Zugriff fehlgeschlagen: ' + err.message);
            }
        };

        document.getElementById('stopBtn').onclick = () => {
            if (stream) stream.getTracks().forEach(track => track.stop());
            document.getElementById('startBtn').style.display = 'inline';
            document.getElementById('stopBtn').style.display = 'none';
            isRunning = false;
            statusEl.innerText = 'Gestoppt';
            addLog('Kamera gestoppt');
        };

        async function detectLoop() {
            if (isRunning && video.readyState === 4 && model) {
                const tensor = tf.browser.fromPixels(video).resizeNearestNeighbor([640, 640]).toFloat().div(255.0).expandDims(0);
                const predictions = await model.executeAsync(tensor);
                const scoresData = predictions[1].dataSync();
                const maxScore = Math.max(...scoresData);
                if (maxScore > 0.5) {
                    detectionsList.innerText = maxScore.toFixed(2);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = 'red'; ctx.lineWidth = 3;
                    ctx.strokeRect(100, 100, 200, 150);
                    ctx.fillStyle = 'red'; ctx.font = '20px Arial';
                    ctx.fillText(`Detektiert: ${(maxScore * 100).toFixed(0)}%`, 110, 95);
                    if (maxScore > 0.7) {
                        triggerAlarm('Bedrohung', maxScore);
                    }
                }
                tensor.dispose(); predictions.forEach(p => p.dispose());
            }
            animationId = requestAnimationFrame(detectLoop);
        }

        function triggerAlarm(className, score) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = `ALARM: ${className} (${(score * 100).toFixed(1)}%)!`;
            alarmCounter++; alarmsCount.innerText = alarmCounter;
            if (Notification.permission === 'granted') new Notification('Beekeeper Alarm!', { body: `${className} erkannt!` });
            addLog(`Alarm: ${className}`);
        }

        if (Notification.permission === 'default') Notification.requestPermission();
        window.onbeforeunload = () => { if (stream) stream.getTracks().forEach(track => track.stop()); if (animationId) cancelAnimationFrame(animationId); };
        loadModel();
        addLog('App geladen');
        document.getElementById('loading').style.display = 'none';
    </script>
</body>
</html>
