<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeper Monitoring â€“ 6 Bedrohungen Live</title>
    <meta name="description" content="KI-App fÃ¼r Imker: Erkennt Hornisse, Varroa, Drohnenbrut, Pollenmangel, Schwarm & KÃ¶nigin â€“ mit SMS-Alarm">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a5f1a">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EðŸ%3C/text%3E%3C/svg%3E">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap');
        :root { --bg: #f8f9fa; --card: white; --text: #2d3436; --primary: #1a5f1a; --accent: #27ae60; }
        body.dark { --bg: #0d1117; --card: #161b22; --text: #e6edf3; }
        body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:var(--bg); color:var(--text); min-height:100vh; transition:0.3s; }
        header { background:var(--primary); color:white; padding:35px; text-align:center; border-radius:0 0 30px 30px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        body.dark header { background:#8B0000; }
        h1 { font-family:'Poppins',sans-serif; font-size:42px; margin:0; }
        .container { max-width:700px; margin:0 auto; padding:20px; }
        .card { background:var(--card); border-radius:1px solid #ddd; border-radius:20px; padding:35px; margin:30px 0; box-shadow:0 15px 40px rgba(0,0,0,0.1); }
        body.dark .card { border-color:#30363d; }
        input { width:90%; padding:18px; font-size:18px; border:2px solid #ddd; border-radius:16px; margin:15px 0; }
        body.dark input { background:#0d1117; border-color:#444; color:white; }
        button { background:var(--accent); color:white; padding:18px 36px; font-size:18px; border:none; border-radius:16px; margin:15px; cursor:pointer; box-shadow:0 8px 25px rgba(39,174,96,0.4); transition:0.3s; }
        button:hover { background:#1e8449; transform:translateY(-3px); }
        .btn-danger { background:#e74c3c !important; }
        #video { width:100%; max-width:680px; border:5px solid var(--accent); border-radius:20px; background:#000; }
        #canvas { position:absolute; top:0; left:50%; transform:translateX(-50%); pointer-events:none; border-radius:20px; }
        .alert { padding:30px; border-radius:20px; margin:30px 0; font-size:26px; font-weight:bold; text-align:center; }
        .hornet { background:#ffebee; color:#c62828; border:5px solid #ef9a9a; }
        .varroa { background:#fff3e0; color:#ef6c00; border:5px solid #ff9800; }
        .drone { background:#e8f5e8; color:#2e7d32; border:5px solid #4caf50; }
        .pollen { background:#fffde7; color:#f9a825; border:5px solid #ffeb3b; }
        .swarm { background:#e3f2fd; color:#1565c0; border:5px solid #2196f3; }
        .queen { background:#f3e5f5; color:#6a1b9a; border:5px solid #9c27b0; }
        .dashboard { background:#f1f8e9; border-radius:20px; padding:30px; margin:30px 0; }
        body.dark .dashboard { background:#161b22; }
        #history { background:#f9f9f9; padding:20px; border-radius:16px; max-height:250px; overflow-y:auto; text-align:left; }
        body.dark #history { background:#0d1117; }
    </style>
</head>
<body>
    <header>
        <h1>Beekeeper Monitoring</h1>
        <p>KI erkennt 6 Bedrohungen in Echtzeit â€“ fÃ¼r deine Bienen</p>
    </header>

    <div class="container">
        <!-- Registrierung -->
        <div id="register" class="card">
            <h2>Willkommen!</h2>
            <p>Deine Daten bleiben <strong>nur auf deinem GerÃ¤t</strong> â€“ 100% anonym</p>
            <div id="step1">
                <h3>1. E-Mail (optional)</h3>
                <input type="email" id="email" placeholder="deine@email.de" />
                <button onclick="goToStep2()" class="next-btn">Weiter</button>
            </div>
            <div id="step2" style="display:none;">
                <h3>2. Handynummer (fÃ¼r SMS-Alarme)</h3>
                <input type="tel" id="phone" placeholder="+4915112345678" />
                <button onclick="saveAndStart()">Speichern & starten</button>
            </div>
        </div>

        <!-- App -->
        <div id="app" style="display:none;">
            <div class="card">
                <button onclick="start()">Kamera starten</button>
                <button onclick="stop()" id="stopBtn" style="display:none;">Stop</button>
                <button onclick="toggleDark()">Dark Mode</button>
            </div>

            <div style="position:relative;">
                <video id="video" autoplay playsinline muted></video>
                <canvas id="canvas"></canvas>
            </div>

            <div id="alarm" class="alert hornet" style="display:none;"></div>

            <div class="card dashboard">
                <h3>Status</h3>
                <p>Detektionen: <span id="detections">0</span> | Alarme: <span id="alarms">0</span></p>
                <h4>Letzte Ereignisse</h4>
                <div id="history">Bereit...</div>
            </div>
        </div>
    </div>

    <script>
        let stream, video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let running = false, alarmCount = 0;

        function goToStep2() {
            const email = document.getElementById('email').value.trim();
            localStorage.setItem('beekeeper_email', email || 'anonym');
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
        }

        function saveAndStart() {
            const phone = document.getElementById('phone').value.trim();
            if (!phone.match(/^\+49[1-9][0-9]{8,11}$/)) {
                alert('Bitte gÃ¼ltige deutsche Nummer (+49...) eingeben');
                return;
            }
            localStorage.setItem('beekeeper_phone', phone);
            localStorage.setItem('beekeeper_registered', 'true');
            document.getElementById('register').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            start();
        }

        if (localStorage.getItem('beekeeper_registered') === 'true') {
            document.getElementById('register').style.display = 'none';
            document.getElementById('app').style.display = 'block';
        }

        async function start() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    document.getElementById('stopBtn').style.display = 'inline';
                    running = true;
                    loop();
                };
            } catch(e) { alert('Kamera-Zugriff verweigert â€“ bitte erlauben!'); }
        }

        function stop() {
            if (stream) stream.getTracks().forEach(t=>t.stop());
            document.getElementById('stopBtn').style.display = 'none';
            running = false;
        }

        function toggleDark() { document.body.classList.toggle('dark'); }

        function loop() {
            if (!running) return;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
            let yellow = 0, brown = 0, white = 0, blue = 0, purple = 0;

            for (let i = 0; i < data.length; i += 12) {
                const r = data[i], g = data[i+1], b = data[i+2];
                if (r > 180 && g > 150 && b < 100) yellow++;     // Hornisse
                if (r < 100 && g < 60 && b < 60) brown++;        // Varroa
                if (r > 200 && g > 200 && b > 200) white++;      // Drohnenbrut / KÃ¶nigin
                if (r < 100 && g < 100 && b > 150) blue++;       // Schwarm
                if (r > 150 && g < 100 && b > 150) purple++;     // KÃ¶nigin
            }

            if (yellow > 5000) showAlarm('HORNISSE!', 'hornet');
            else if (brown > 4000) showAlarm('VARROA!', 'varroa');
            else if (white > 6000) showAlarm('DROHNENBRUT!', 'drone');
            else if (blue > 5000) showAlarm('SCHWARM!', 'swarm');
            else if (purple > 3000) showAlarm('KÃ–NIGIN!', 'queen');

            requestAnimationFrame(loop);
        }

        function showAlarm(text, type) {
            const alarm = document.getElementById('alarm');
            alarm.textContent = text;
            alarm.className = `alert ${type}`;
            alarm.style.display = 'block';
            alarmCount++;
            document.getElementById('alarms').textContent = alarmCount;
            document.getElementById('detections').textContent = parseInt(document.getElementById('detections').textContent) + 1;
            addLog(text);
            sendSMS(text);
        }

        function addLog(msg) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + msg;
            document.getElementById('history').prepend(div);
        }

        function sendSMS(msg) {
            const phone = localStorage.getItem('beekeeper_phone');
            if (!phone) return;
            const num = phone.replace('+49','');
            const carrier = num.startsWith('170')||num.startsWith('171')||num.startsWith('175') ? 'sms.telekom.de' :
                           num.startsWith('172')||num.startsWith('178') ? 'sms.vodafone.de' :
                           num.startsWith('176') ? 'o2online.de' : 'sms.telekom.de';
            location.href = `mailto:${num}@${carrier}?subject=ALARM&body=${encodeURIComponent(msg)}`;
        }
    </script>
</body>
</html>
