<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beekeeper Monitoring – Hornissen & Varroa Live-Überwachung</title>
    <link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&display=swap');
        body { font-family: 'Roboto', sans-serif; margin:0; padding:20px; background:#f0f8ff; text-align:center; }
        body.dark { background:#111; color:#fff; }
        header { background:#1a5f1a; color:white; padding:25px; border-radius:0 0 20px 20px; box-shadow:0 8px 25px rgba(0,0,0,0.2); }
        body.dark header { background:#8B0000 !important; color:#fff !important; }
        .card { background:white; border-radius:16px; padding:25px; margin:20px auto; max-width:560px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        body.dark .card { background:#1f1f1f; }
        button { background:#27ae60; color:white; padding:14px 28px; border:none; border-radius:12px; font-size:16px; cursor:pointer; margin:10px; }
        button:hover { background:#1e8449; }
        .sms-btn { background:#e74c3c !important; }
        input { width:100%; padding:14px; border:2px solid #ddd; border-radius:12px; font-size:16px; margin:10px 0; }
        #video { width:100%; max-width:640px; border:3px solid #4CAF50; border-radius:16px; }
        #canvas { position:absolute; top:0; left:0; pointer-events:none; }
        .alert { background:#ffebee; color:#c62828; padding:15px; border-radius:12px; margin:15px 0; font-weight:bold; }
        .dashboard { background:#e8f5e8; border-radius:16px; padding:20px; margin:20px auto; max-width:560px; }
        body.dark .dashboard { background:#1a1a1a; }
        #loading { font-size:20px; color:#27ae60; margin:30px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
    <header><h1>Beekeeper Monitoring</h1><p>KI-gestützte Echtzeit-Überwachung für deine Bienen</p></header>

    <!-- Registrierung / Login mit 2FA -->
    <div id="loginScreen" class="card">
        <h2>Willkommen bei Beekeeper Monitoring</h2>
        <p>Bitte bestätige deine Identität (E-Mail oder Handynummer)</p>
        <input type="text" id="contactInput" placeholder="E-Mail oder +4915112345678" />
        <button onclick="sendCode()">Code senden</button>
        <div id="codeSection" style="display:none; margin-top:15px;">
            <input type="text" id="codeInput" placeholder="6-stelliger Code" maxlength="6" />
            <button onclick="verifyCode()" class="sms-btn">Bestätigen</button>
        </div>
        <div id="loginStatus" style="margin-top:10px; color:#27ae60; font-weight:bold;"></div>
    </div>

    <div id="mainApp" style="display:none;">
        <div id="loading">Lade KI-Modell…</div>
        <div class="card">
            <button id="startBtn">Kamera & Mikrofon starten</button>
            <button id="stopBtn" style="display:none;">Stop</button>
            <button onclick="testSMS()" class="sms-btn">SMS-Alarm testen</button>
            <button id="darkToggle">Dark Mode</button>
        </div>
        <div style="position:relative; margin:20px 0;">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
        </div>
        <div id="result" class="alert" style="display:none;"></div>
        <div class="card dashboard">
            <h3>Dashboard</h3>
            <p>Status: <span id="status">Bereit</span> | Detektionen: <span id="detections">0</span> | Alarme: <span id="alarms">0</span></p>
            <h4>Letzte Ereignisse</h4>
            <div id="history">Keine Einträge</div>
        </div>
    </div>

    <script>
        const BACKEND = 'https://norynox.pythonanywhere.com';  // Dein Backend
        let model, video = document.getElementById('video'), canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        let stream, isRunning = false, alarmCounter = 0;

        function addLog(e) {
            const history = document.getElementById('history');
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + e;
            history.prepend(div);
        }

        async function sendCode() {
            const contact = document.getElementById('contactInput').value.trim();
            if (!contact) return alert('Bitte E-Mail oder Nummer eingeben');
            const res = await fetch(`${BACKEND}/api/send-code`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contact})});
            const data = await res.json();
            if (data.status === 'success') {
                document.getElementById('codeSection').style.display = 'block';
                document.getElementById('loginStatus').textContent = 'Code gesendet! Prüfe SMS/E-Mail';
                localStorage.setItem('pending_contact', contact);
            } else alert(data.message || 'Fehler');
        }

        async function verifyCode() {
            const code = document.getElementById('codeInput').value;
            const contact = localStorage.getItem('pending_contact');
            if (!code || code.length !== 6) return alert('6-stelliger Code erforderlich');
            const res = await fetch(`${BACKEND}/api/verify-code`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contact, code})});
            const data = await res.json();
            if (data.status === 'success') {
                localStorage.setItem('beekeeper_verified', 'true');
                localStorage.setItem('beekeeper_contact', contact);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                addLog('Login erfolgreich');
                loadModel();
            } else alert('Falscher Code');
        }

        if (localStorage.getItem('beekeeper_verified') === 'true') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadModel();
        }

        async function loadModel() {
            try {
                await tf.setBackend('webgl');
                model = await tf.loadGraphModel('https://tfhub.dev/google/tfjs-model/yolov8n-detection/1/default/1', {fromTFHub:true});
                document.getElementById('status').textContent = 'KI bereit';
            } catch(e) { document.getElementById('status').textContent = 'Demo-Modus'; }
            document.getElementById('loading').style.display = 'none';
        }

        document.getElementById('startBtn').onclick = async () => {
            if (!model) await loadModel();
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    document.getElementById('startBtn').style.display='none';
                    document.getElementById('stopBtn').style.display='inline';
                    isRunning = true;
                    detectLoop();
                    addLog('Kamera gestartet');
                };
            } catch(e) { alert('Kamera-Zugriff verweigert'); }
        };

        document.getElementById('stopBtn').onclick = () => {
            if (stream) stream.getTracks().forEach(t=>t.stop());
            document.getElementById('startBtn').style.display='inline';
            document.getElementById('stopBtn').style.display='none';
            isRunning = false;
            addLog('Kamera gestoppt');
        };

        async function detectLoop() {
            if (!isRunning) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const tensor = tf.browser.fromPixels(video).resizeNearestNeighbor([640,640]).toFloat().div(255).expandDims();
            const pred = await model.executeAsync(tensor);
            const scores = pred[1].dataSync();
            const max = Math.max(...scores);
            if (max > 0.7) {
                ctx.strokeStyle = 'red'; ctx.lineWidth = 5;
                ctx.strokeRect(50,50,canvas.width-100,canvas.height-100);
                ctx.fillStyle = 'red'; ctx.font = '30px Arial';
                ctx.fillText(`Hornisse ${(max*100).toFixed(0)}%`, 70, 50);
                await fetch(`${BACKEND}/api/alarm`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({score:max, phone:localStorage.getItem('beekeeper_contact')})});
                document.getElementById('result').style.display='block';
                document.getElementById('result').innerHTML = `ALARM! SMS gesendet an ${localStorage.getItem('beekeeper_contact')}`;
                alarmCounter++; document.getElementById('alarms').textContent = alarmCounter;
                addLog('SMS-Alarm gesendet');
            }
            tensor.dispose(); pred.forEach(t=>t.dispose());
            requestAnimationFrame(detectLoop);
        }

        document.getElementById('darkToggle').onclick = () => document.body.classList.toggle('dark');
        addLog('App geladen');
    </script>
</body>
</html>
